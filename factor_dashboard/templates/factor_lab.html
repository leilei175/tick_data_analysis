{% extends "base.html" %}

{% block title %}因子分析实验室 - 量化研究中台{% endblock %}

{% block extra_css %}
<style>
    .lab-container {
        padding: 20px;
        max-width: 1600px;
        margin: 0 auto;
    }

    .lab-header {
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border-color);
    }

    .lab-header h2 {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0 0 8px 0;
    }

    .lab-header p {
        color: var(--text-secondary);
        margin: 0;
        font-size: 0.9rem;
    }

    /* 步骤指示器 */
    .steps-indicator {
        display: flex;
        justify-content: space-between;
        margin-bottom: 24px;
        position: relative;
    }

    .steps-indicator::before {
        content: '';
        position: absolute;
        top: 20px;
        left: 10%;
        right: 10%;
        height: 2px;
        background: var(--border-color);
        z-index: 0;
    }

    .step-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        z-index: 1;
        background: var(--bg-primary);
        padding: 0 16px;
    }

    .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--bg-secondary);
        border: 2px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 8px;
        transition: all 0.3s ease;
    }

    .step-item.active .step-number {
        background: var(--primary-color);
        border-color: var(--primary-color);
        color: white;
    }

    .step-item.completed .step-number {
        background: var(--success-color);
        border-color: var(--success-color);
        color: white;
    }

    .step-label {
        font-size: 0.85rem;
        color: var(--text-secondary);
        text-align: center;
    }

    .step-item.active .step-label {
        color: var(--primary-color);
        font-weight: 500;
    }

    /* 配置面板 */
    .config-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
    }

    .config-panel {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 20px;
    }

    .panel-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border-color);
    }

    .panel-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
    }

    .panel-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .form-group {
        margin-bottom: 16px;
    }

    .form-label {
        display: block;
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-bottom: 6px;
    }

    .form-select, .form-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 0.9rem;
        transition: border-color 0.2s;
    }

    .form-select:focus, .form-input:focus {
        outline: none;
        border-color: var(--primary-color);
    }

    .form-select:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }

    .checkbox-group {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
    }

    .checkbox-item {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .checkbox-item input[type="checkbox"] {
        width: 16px;
        height: 16px;
        cursor: pointer;
    }

    /* 参数折叠面板 */
    .params-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--primary-color);
        font-size: 0.85rem;
        cursor: pointer;
        margin-top: 8px;
    }

    .params-toggle:hover {
        text-decoration: underline;
    }

    .params-content {
        display: none;
        margin-top: 12px;
        padding: 12px;
        background: var(--bg-secondary);
        border-radius: 8px;
    }

    .params-content.show {
        display: block;
    }

    /* 操作按钮 */
    .action-bar {
        display: flex;
        gap: 12px;
        justify-content: center;
        margin-bottom: 24px;
    }

    .btn {
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-primary {
        background: linear-gradient(135deg, #0b3a67 0%, #0f5c9a 100%);
        color: white;
        border: 1px solid #0a2f54;
        box-shadow: 0 6px 16px rgba(11, 58, 103, 0.28);
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #0a3158 0%, #0c4d80 100%);
        transform: translateY(-1px);
    }

    .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .btn-secondary {
        background: var(--bg-secondary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
        background: var(--border-color);
    }

    /* 结果展示区域 */
    .results-section {
        display: none;
        margin-top: 32px;
    }

    .results-section.show {
        display: block;
    }

    .results-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
    }

    .result-card {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 20px;
    }

    .result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .result-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .result-actions {
        display: flex;
        gap: 8px;
    }

    /* 统计卡片 */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 12px;
    }

    .stat-card {
        padding: 12px;
        background: var(--bg-secondary);
        border-radius: 8px;
        text-align: center;
    }

    .stat-value {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 4px;
    }

    .stat-value.positive {
        color: var(--success-color);
    }

    .stat-value.negative {
        color: var(--danger-color);
    }

    .stat-label {
        font-size: 0.8rem;
        color: var(--text-secondary);
    }

    /* 分层收益表格 */
    .quantile-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 12px;
    }

    .quantile-table th,
    .quantile-table td {
        padding: 10px 12px;
        text-align: center;
        border-bottom: 1px solid var(--border-color);
    }

    .quantile-table th {
        background: var(--bg-secondary);
        font-weight: 600;
        font-size: 0.85rem;
        color: var(--text-secondary);
    }

    .quantile-table td {
        font-size: 0.9rem;
    }

    .quantile-table tr:hover td {
        background: var(--bg-secondary);
    }

    /* 图表容器 */
    .chart-container {
        width: 100%;
        height: 300px;
        margin-top: 16px;
    }

    /* 加载状态 */
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .loading-overlay.show {
        display: flex;
    }

    .loading-content {
        background: var(--bg-primary);
        padding: 32px 48px;
        border-radius: 12px;
        text-align: center;
    }

    .loading-spinner {
        width: 48px;
        height: 48px;
        border: 4px solid var(--border-color);
        border-top-color: var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
    }

    .loading-text {
        color: var(--text-secondary);
        font-size: 0.95rem;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* 提示信息 */
    .toast {
        position: fixed;
        bottom: 24px;
        right: 24px;
        padding: 12px 20px;
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1001;
        display: none;
        animation: slideIn 0.3s ease;
    }

    .toast.show {
        display: block;
    }

    .toast.success {
        border-color: var(--success-color);
    }

    .toast.error {
        border-color: var(--danger-color);
    }

    @keyframes slideIn {
        from {
            transform: translateY(20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    /* 响应式 */
    @media (max-width: 768px) {
        .config-grid {
            grid-template-columns: 1fr;
        }

        .form-row {
            grid-template-columns: 1fr;
        }

        .results-grid {
            grid-template-columns: 1fr;
        }

        .action-bar {
            flex-direction: column;
        }

        .btn {
            width: 100%;
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block header_title %}因子分析实验室{% endblock %}

{% block content %}
<div class="lab-container">
    <div class="lab-header">
        <h2>因子分析实验室</h2>
        <p>选择因子、配置预处理参数、执行分析，一站式完成因子研究与评估</p>
    </div>

    <!-- 步骤指示器 -->
    <div class="steps-indicator">
        <div class="step-item active" data-step="1">
            <div class="step-number">1</div>
            <div class="step-label">选择因子</div>
        </div>
        <div class="step-item" data-step="2">
            <div class="step-number">2</div>
            <div class="step-label">预处理</div>
        </div>
        <div class="step-item" data-step="3">
            <div class="step-number">3</div>
            <div class="step-label">分析配置</div>
        </div>
        <div class="step-item" data-step="4">
            <div class="step-number">4</div>
            <div class="step-label">结果展示</div>
        </div>
    </div>

    <!-- 配置面板 -->
    <div class="config-grid">
        <!-- 步骤1: 选择因子 -->
        <div class="config-panel">
            <div class="panel-header">
                <div class="panel-icon" style="background: rgba(52, 152, 219, 0.15); color: #3498db;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 3H5a2 2 0 00-2 2v4m6-6h10a2 2 0 012 2v4M9 3v18m0 0h10a2 2 0 002-2v-4M9 21H5a2 2 0 01-2-2v-4"/>
                    </svg>
                </div>
                <div class="panel-title">步骤1: 选择因子</div>
            </div>

            <div class="form-group">
                <label class="form-label">因子来源</label>
                <select id="factorSource" class="form-select" onchange="loadFactors()">
                    <option value="high_frequency">高频因子 (High Frequency)</option>
                    <option value="fundamental">基本面因子 (Fundamental)</option>
                    <option value="technical">技术指标因子 (Technical)</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">选择因子</label>
                <select id="factorName" class="form-select">
                    <option value="">请先选择因子来源...</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">股票池</label>
                <select id="stockPool" class="form-select">
                    <option value="zz1000">中证1000 (ZZ1000)</option>
                    <option value="hs300">沪深300 (HS300)</option>
                    <option value="zzxf">中证消费 (ZZXF)</option>
                </select>
            </div>
        </div>

        <!-- 步骤2: 预处理 -->
        <div class="config-panel">
            <div class="panel-header">
                <div class="panel-icon" style="background: rgba(155, 89, 182, 0.15); color: #9b59b6;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 20h9M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/>
                    </svg>
                </div>
                <div class="panel-title">步骤2: 因子预处理</div>
            </div>

            <div class="form-group">
                <label class="form-label">预处理方法</label>
                <select id="preprocessMethod" class="form-select" onchange="updatePreprocessParams()">
                    <option value="">无预处理</option>
                    <option value="zscore">标准化 (Z-Score)</option>
                    <option value="winsorize">去极值 (Winsorize)</option>
                    <option value="normalize">归一化 (0-1)</option>
                    <option value="rank">排序映射 (Rank)</option>
                    <option value="neutralize">中性化 (Neutralize)</option>
                    <option value="mad">MAD去极值</option>
                </select>
            </div>

            <div id="preprocessParams" class="params-content">
                <!-- 动态参数 -->
            </div>
        </div>

        <!-- 步骤3: 分析配置 -->
        <div class="config-panel">
            <div class="panel-header">
                <div class="panel-icon" style="background: rgba(46, 204, 113, 0.15); color: #2ecc71;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M12 2v4m0 12v4m10-10h-4M6 12H2"/>
                    </svg>
                </div>
                <div class="panel-title">步骤3: 分析配置</div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">起始日期</label>
                    <input type="date" id="startDate" class="form-input" value="2026-01-01">
                </div>
                <div class="form-group">
                    <label class="form-label">结束日期</label>
                    <input type="date" id="endDate" class="form-input" value="2026-01-31">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">收益计算方式</label>
                <select id="returnsType" class="form-select">
                    <option value="open2close">次日开盘 → 次日收盘</option>
                    <option value="open2open_next">次日开盘 → T+2开盘</option>
                    <option value="close2close_next">次日收盘 → T+2收盘</option>
                    <option value="close2close_n">次日收盘 → T+N收盘</option>
                </select>
            </div>

            <div class="form-group" id="returnsNGroup" style="display: none;">
                <label class="form-label">持有天数 (N)</label>
                <input type="number" id="returnsN" class="form-input" value="5" min="1" max="30">
            </div>

            <div class="form-group">
                <label class="form-label">分层数量</label>
                <select id="quantiles" class="form-select">
                    <option value="3">3 分层</option>
                    <option value="5" selected>5 分层</option>
                    <option value="10">10 分层</option>
                </select>
            </div>
        </div>

        <!-- 过滤条件 -->
        <div class="config-panel">
            <div class="panel-header">
                <div class="panel-icon" style="background: rgba(230, 126, 34, 0.15); color: #e67e22;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
                    </svg>
                </div>
                <div class="panel-title">过滤条件</div>
            </div>

            <div class="checkbox-group">
                <label class="checkbox-item">
                    <input type="checkbox" id="filterLimitUp" checked>
                    <span>过滤涨停</span>
                </label>
                <label class="checkbox-item">
                    <input type="checkbox" id="filterMinAmount" checked>
                    <span>过滤成交不足</span>
                </label>
                <label class="checkbox-item">
                    <input type="checkbox" id="filterMinTurnover" checked>
                    <span>过滤低换手</span>
                </label>
            </div>

            <div class="params-toggle" onclick="toggleFilterParams()">
                <span>详细参数</span>
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"/>
                </svg>
            </div>

            <div id="filterParams" class="params-content">
                <div class="form-group">
                    <label class="form-label">最小成交额 (万元)</label>
                    <input type="number" id="minAmount" class="form-input" value="1000">
                </div>
                <div class="form-group">
                    <label class="form-label">最小换手率 (%)</label>
                    <input type="number" id="minTurnover" class="form-input" value="0.5" step="0.1">
                </div>
            </div>
        </div>
    </div>

    <!-- 操作按钮 -->
    <div class="action-bar">
        <button class="btn btn-secondary" onclick="previewPreprocess()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
            </svg>
            预览效果
        </button>
        <button class="btn btn-primary" id="analyzeBtn" onclick="runAnalysis()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="5 3 19 12 5 21 5 3"/>
            </svg>
            开始分析
        </button>
    </div>

    <!-- 结果展示区域 -->
    <div class="results-section" id="resultsSection">
        <h3 style="margin-bottom: 16px; font-size: 1.1rem; font-weight: 600;">分析结果</h3>

        <div class="results-grid">
            <!-- IC分析结果 -->
            <div class="result-card">
                <div class="result-header">
                    <div class="result-title">IC 分析</div>
                </div>
                <div class="stats-grid" id="icStats">
                    <!-- 动态填充 -->
                </div>
            </div>

            <!-- 多空组合 -->
            <div class="result-card">
                <div class="result-header">
                    <div class="result-title">多空组合</div>
                </div>
                <div class="stats-grid" id="longShortStats">
                    <!-- 动态填充 -->
                </div>
            </div>
        </div>

        <!-- 分层收益 -->
        <div class="result-card" style="margin-bottom: 20px;">
            <div class="result-header">
                <div class="result-title">分层收益分析</div>
            </div>
            <table class="quantile-table" id="quantileTable">
                <thead>
                    <tr>
                        <th>分层</th>
                        <th>因子均值</th>
                        <th>收益均值</th>
                        <th>收益标准差</th>
                        <th>夏普比率</th>
                        <th>样本数</th>
                    </tr>
                </thead>
                <tbody id="quantileTableBody">
                    <!-- 动态填充 -->
                </tbody>
            </table>
        </div>

        <!-- 图表区域 -->
        <div class="results-grid">
            <div class="result-card">
                <div class="result-header">
                    <div class="result-title">IC 时间序列</div>
                </div>
                <div id="icChart" class="chart-container"></div>
            </div>

            <div class="result-card">
                <div class="result-header">
                    <div class="result-title">分层收益对比</div>
                </div>
                <div id="quantileChart" class="chart-container"></div>
            </div>
        </div>

        <div class="results-grid">
            <div class="result-card">
                <div class="result-header">
                    <div class="result-title">IC 累积和走势</div>
                </div>
                <div id="icCumsumChart" class="chart-container"></div>
            </div>

            <div class="result-card">
                <div class="result-header">
                    <div class="result-title">分组累积净值走势</div>
                </div>
                <div id="quantileNavChart" class="chart-container"></div>
            </div>
        </div>

        <!-- 操作按钮 -->
        <div class="action-bar">
            <button class="btn btn-secondary" onclick="saveResult()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                    <polyline points="17 21 17 13 7 13 7 21"/>
                    <polyline points="7 3 7 8 15 8"/>
                </svg>
                保存结果
            </button>
            <button class="btn btn-secondary" onclick="downloadReport()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                </svg>
                下载报告
            </button>
        </div>
    </div>
</div>

<!-- 加载状态 -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">正在执行分析...</div>
    </div>
</div>

<!-- 提示信息 -->
<div class="toast" id="toast"></div>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/factor_lab.js') }}"></script>
{% endblock %}
