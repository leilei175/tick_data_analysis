<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>中证1000因子数据 - 高频因子分析平台</title>
    {% extends "base.html" %}
    {% block header_title %}中证1000因子{% endblock %}
    {% block extra_css %}
    <style>
        .zz1000-banner {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(59, 130, 246, 0.1));
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 20px;
        }
        .zz1000-title {
            font-size: 22px;
            font-weight: 700;
            background: linear-gradient(135deg, #8b5cf6, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .zz1000-desc {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 8px;
        }
        .stat-card-csi {
            position: relative;
            overflow: hidden;
        }
        .stat-card-csi::before {
            background: linear-gradient(135deg, #8b5cf6, #3b82f6) !important;
        }
        .info-banner {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .info-banner svg {
            width: 24px;
            height: 24px;
            color: var(--accent-primary);
            flex-shrink: 0;
        }
        .info-banner-text {
            color: var(--text-secondary);
            font-size: 13px;
        }
        .info-banner-text strong {
            color: var(--accent-primary);
        }
    </style>
    {% endblock %}
</head>
<body>
    {% block content %}
    <div class="zz1000-banner fade-in">
        <div class="zz1000-title">中证1000指数成分股因子数据</div>
        <div class="zz1000-desc">
            高频因子数据查看器 | 数据周期: 2026年2月 | 成分股: 100只
        </div>
    </div>

    <div class="info-banner fade-in">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="16" x2="12" y2="12"/>
            <line x1="12" y1="8" x2="12.01" y2="8"/>
        </svg>
        <div class="info-banner-text">
            <strong>说明：</strong>当前展示中证1000成分股（取前100只）的高频因子数据。
            IC分析、分层分析等需要接入收益率数据后才能计算。
        </div>
    </div>

    <!-- 统计卡片 -->
    <div class="stat-grid mb-24 fade-in">
        <div class="stat-card stat-card-csi">
            <div class="stat-label">因子数量</div>
            <div class="stat-value" id="factorCount">-</div>
        </div>
        <div class="stat-card success">
            <div class="stat-label">数据年份</div>
            <div class="stat-value" id="yearCount">-</div>
        </div>
        <div class="stat-card warning">
            <div class="stat-label">文件数量</div>
            <div class="stat-value" id="fileCount">-</div>
        </div>
        <div class="stat-card info">
            <div class="stat-label">总大小</div>
            <div class="stat-value" id="totalSize">-</div>
        </div>
    </div>

    <!-- 图表区域 -->
    <div class="chart-section mb-24">
        <div class="chart-container fade-in">
            <div class="card-header">
                <div>
                    <div class="card-title">各因子数据量</div>
                    <div class="card-subtitle">按因子类型统计记录数</div>
                </div>
            </div>
            <div id="recordChart" style="height:350px;"></div>
        </div>
        <div class="chart-container fade-in">
            <div class="card-header">
                <div>
                    <div class="card-title">因子文件大小</div>
                    <div class="card-subtitle">按因子类型统计存储大小</div>
                </div>
            </div>
            <div id="sizeChart" style="height:350px;"></div>
        </div>
    </div>

    <!-- 因子列表 -->
    <div class="card fade-in">
        <div class="card-header">
            <div>
                <div class="card-title">可用因子列表</div>
                <div class="card-subtitle">点击查看因子详情</div>
            </div>
        </div>
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>因子名称</th>
                        <th>数据年份</th>
                        <th>文件大小</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="factorTableBody">
                    <tr><td colspan="5" class="loading"><div class="loading-spinner"></div></td></tr>
                </tbody>
            </table>
        </div>
    </div>
    {% endblock %}

    {% block extra_js %}
    <script>
        async function loadZZ1000Data() {
            try {
                const factorsRes = await fetch('/api/factors/list');
                const data = await factorsRes.json();

                if (data.status !== 'success') return;

                const factors = data.data;
                const files = factors.files;

                // 更新统计
                document.getElementById('factorCount').textContent = factors.factors.length;
                document.getElementById('yearCount').textContent = factors.years.length + ' 年';
                document.getElementById('fileCount').textContent = files.length;

                const totalSize = files.reduce((sum, f) => sum + f.file_size_mb, 0);
                document.getElementById('totalSize').textContent = totalSize.toFixed(2) + ' MB';

                // 绘制图表
                renderRecordChart(files);
                renderSizeChart(files);

                // 渲染表格
                renderTable(factors.factors, files);
            } catch (error) {
                console.error('Error loading ZZ1000 data:', error);
            }
        }

        function renderRecordChart(files) {
            // 按因子计算总记录数
            const factorRecords = {};
            files.forEach(f => {
                if (!factorRecords[f.factor]) {
                    factorRecords[f.factor] = 0;
                }
                factorRecords[f.factor] += f.file_size_mb * 10000; // 估算
            });

            const trace = {
                x: Object.keys(factorRecords),
                y: Object.values(factorRecords),
                type: 'bar',
                marker: {
                    color: '#8b5cf6',
                    opacity: 0.8
                }
            };

            const layout = {
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                font: { color: '#94a3b8', family: 'Inter' },
                margin: { t: 10, r: 10, b: 80, l: 60 },
                xaxis: { tickangle: -45, title: '因子' },
                yaxis: { title: '估算记录数', gridcolor: '#2d3748' }
            };

            Plotly.newPlot('recordChart', [trace], layout, {responsive: true, displayModeBar: false});
        }

        function renderSizeChart(files) {
            const factorSizes = {};
            files.forEach(f => {
                if (!factorSizes[f.factor]) {
                    factorSizes[f.factor] = 0;
                }
                factorSizes[f.factor] += f.file_size_mb;
            });

            const trace = {
                y: Object.keys(factorSizes),
                x: Object.values(factorSizes),
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: '#3b82f6',
                    opacity: 0.8
                },
                text: Object.values(factorSizes).map(s => s.toFixed(2) + ' MB'),
                textposition: 'outside'
            };

            const layout = {
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                font: { color: '#94a3b8', family: 'Inter' },
                margin: { t: 10, r: 80, b: 30, l: 100 },
                xaxis: { title: '文件大小 (MB)', gridcolor: '#2d3748' },
                yaxis: { gridcolor: 'transparent' }
            };

            Plotly.newPlot('sizeChart', [trace], layout, {responsive: true, displayModeBar: false});
        }

        function renderTable(factors, files) {
            const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#ec4899', '#84cc16'];

            const tbody = document.getElementById('factorTableBody');
            tbody.innerHTML = factors.map((factor, index) => {
                const factorFiles = files.filter(f => f.factor === factor);
                const totalSize = factorFiles.reduce((sum, f) => sum + f.file_size_mb, 0);
                const years = [...new Set(factorFiles.map(f => f.year))].join(', ');

                return `
                    <tr>
                        <td>
                            <span style="display:inline-flex;align-items:center;justify-content:center;width:24px;height:24px;border-radius:50%;background:${colors[index % colors.length]}20;color:${colors[index % colors.length]};font-size:11px;font-weight:600">
                                ${index + 1}
                            </span>
                        </td>
                        <td><strong>${factor}</strong></td>
                        <td>${years}</td>
                        <td>${totalSize.toFixed(2)} MB</td>
                        <td>
                            <a href="/factor-viewer?factor=${factor}" class="btn-action">查看</a>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        document.addEventListener('DOMContentLoaded', loadZZ1000Data);
    </script>
    {% endblock %}
</body>
</html>
