{% extends "base.html" %}

{% block title %}数据管理 - 高频因子分析平台{% endblock %}

{% block content %}
<div class="content-section">
    <!-- 页面头部 -->
    <div class="card-header">
        <div>
            <h2 class="card-title">数据管理</h2>
            <p class="card-subtitle">管理 daily_data 目录下的所有数据源</p>
        </div>
        <div style="display: flex; gap: 8px;">
            <button class="btn" onclick="refreshDataStatus()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                </svg>
                刷新状态
            </button>
            <button class="btn btn-primary" onclick="showUpdateModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                更新数据
            </button>
        </div>
    </div>

    <!-- 系统状态 -->
    <div class="stats-grid" style="margin-bottom: 20px;">
        <div class="stat-card info">
            <div class="stat-icon blue">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    <line x1="3" y1="9" x2="21" y2="9"/>
                    <line x1="9" y1="21" x2="9" y2="9"/>
                </svg>
            </div>
            <div>
                <div class="stat-label">数据表数量</div>
                <div class="stat-value" id="tableCount">5</div>
            </div>
        </div>
        <div class="stat-card success">
            <div class="stat-icon green">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"/>
                </svg>
            </div>
            <div>
                <div class="stat-label">已更新表数</div>
                <div class="stat-value" id="updatedCount">0</div>
            </div>
        </div>
        <div class="stat-card warning">
            <div class="stat-icon orange">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                </svg>
            </div>
            <div>
                <div class="stat-label">最近更新</div>
                <div class="stat-value" id="lastUpdate" style="font-size: 14px;">-</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon purple">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                    <path d="M2 17l10 5 10-5"/>
                    <path d="M2 12l10 5 10-5"/>
                </svg>
            </div>
            <div>
                <div class="stat-label">今日状态</div>
                <div class="stat-value" id="tradingStatus" style="font-size: 14px;">-</div>
            </div>
        </div>
    </div>

    <!-- 数据表列表 -->
    <div class="section-card">
        <div class="section-header">
            <span class="section-title">数据表概览</span>
            <span style="font-size: 12px; color: var(--text-muted);">点击表名查看字段详情</span>
        </div>
        <div class="table-container">
            <table class="data-table" id="dataTableList">
                <thead>
                    <tr>
                        <th>状态</th>
                        <th>数据表</th>
                        <th>描述</th>
                        <th>最新数据日期</th>
                        <th>字段数量</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                    <tr>
                        <td colspan="6" class="loading-cell">
                            <div class="loading">
                                <div class="loading-spinner"></div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- 字段详情 -->
    <div class="section-card" id="fieldsSection" style="display: none; margin-top: 16px;">
        <div class="section-header">
            <span class="section-title" id="fieldsTableName">字段详情</span>
            <button class="btn btn-sm" onclick="closeFieldsSection()">关闭</button>
        </div>
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>序号</th>
                        <th>字段名</th>
                        <th>类型</th>
                        <th>说明</th>
                    </tr>
                </thead>
                <tbody id="fieldsTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- 日志输出 -->
    <div class="section-card" style="margin-top: 16px;">
        <div class="section-header">
            <span class="section-title">更新日志</span>
            <button class="btn btn-sm" onclick="clearLogs()">清空</button>
        </div>
        <div id="logOutput" style="
            background: var(--bg-tertiary);
            padding: 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text-secondary);
            max-height: 200px;
            overflow-y: auto;
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
        ">
            <div style="color: var(--text-muted);">等待更新...</div>
        </div>
    </div>
</div>

<!-- 更新模态框 -->
<div id="updateModal" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 2000;
    align-items: center;
    justify-content: center;
">
    <div class="section-card" style="width: 480px; max-width: 90%;">
        <div class="section-header">
            <span class="section-title">更新数据</span>
            <button class="btn btn-sm" onclick="closeUpdateModal()">关闭</button>
        </div>
        <div style="padding: 16px;">
            <div style="margin-bottom: 16px;">
                <label style="
                    display: block;
                    font-size: 12px;
                    color: var(--text-muted);
                    margin-bottom: 8px;
                ">选择数据类型</label>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                    <label style="
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        padding: 10px 14px;
                        background: var(--bg-tertiary);
                        border: 1px solid var(--border-color);
                        border-radius: var(--radius-md);
                        cursor: pointer;
                        transition: all 0.2s;
                    ">
                        <input type="checkbox" id="updateDaily" checked style="width: 16px; height: 16px;">
                        <span style="font-size: 13px;">日线行情</span>
                    </label>
                    <label style="
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        padding: 10px 14px;
                        background: var(--bg-tertiary);
                        border: 1px solid var(--border-color);
                        border-radius: var(--radius-md);
                        cursor: pointer;
                    ">
                        <input type="checkbox" id="updateDailyBasic" checked style="width: 16px; height: 16px;">
                        <span style="font-size: 13px;">每日基本面</span>
                    </label>
                    <label style="
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        padding: 10px 14px;
                        background: var(--bg-tertiary);
                        border: 1px solid var(--border-color);
                        border-radius: var(--radius-md);
                        cursor: pointer;
                    ">
                        <input type="checkbox" id="updateFinancial" style="width: 16px; height: 16px;">
                        <span style="font-size: 13px;">财务报表</span>
                    </label>
                </div>
            </div>

            <div style="margin-bottom: 16px;">
                <label style="
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    padding: 10px 14px;
                    background: var(--bg-tertiary);
                    border: 1px solid var(--accent-info);
                    border-radius: var(--radius-md);
                    cursor: pointer;
                ">
                    <input type="checkbox" id="includeToday" style="width: 16px; height: 16px;">
                    <span style="font-size: 13px; color: var(--accent-info);">包含今天的数据 (18:00后)</span>
                </label>
            </div>

            <div id="updateInfo" style="
                background: var(--bg-tertiary);
                padding: 12px;
                border-radius: var(--radius-md);
                font-size: 12px;
                color: var(--text-secondary);
                margin-bottom: 16px;
            ">
                <div style="margin-bottom: 4px;"><strong>当前时间:</strong> <span id="currentTime">-</span></div>
                <div><strong>市场状态:</strong> <span id="marketStatus">-</span></div>
            </div>

            <button class="btn btn-primary" style="width: 100%; justify-content: center;" onclick="executeUpdate()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                    <path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                开始更新
            </button>
        </div>
    </div>
</div>

<!-- 字段说明映射 -->
<script>
const FIELD_DESCRIPTIONS = {
    // 日线数据
    'ts_code': '股票代码',
    'trade_date': '交易日期',
    'open': '开盘价',
    'high': '最高价',
    'low': '最低价',
    'close': '收盘价',
    'pre_close': '前收盘价',
    'change': '涨跌幅',
    'pct_chg': '涨跌幅(%)',
    'vol': '成交量(手)',
    'amount': '成交额(千元)',

    // 每日基本面
    'turnover_rate': '换手率(%)',
    'turnover_rate_f': '换手率(自由流通股)',
    'volume_ratio': '量比',
    'pe': '市盈率',
    'pe_ttm': '市盈率TTM',
    'pb': '市净率',
    'ps': '市销率',
    'ps_ttm': '市销率TTM',
    'dv_ratio': '股息率(%)',
    'dv_ttm': '股息率TTM(%)',
    'total_share': '总股本(万股)',
    'float_share': '流通股本(万股)',
    'free_share': '自由流通股本(万股)',
    'total_mv': '总市值(万元)',
    'circ_mv': '流通市值(万元)',

    // 现金流量表
    'n_cashflow_act': '经营活动现金流量净额',
    'n_cashflow_inv_act': '投资活动现金流量净额',
    'n_cash_flows_fnc_act': '筹资活动现金流量净额',
    'c_fr_sale_sg': '销售商品提供劳务收到的现金',
    'c_paid_goods_s': '购买商品接受劳务支付的现金',
    'net_profit': '净利润',

    // 利润表
    'total_revenue': '营业总收入',
    'revenue': '营业收入',
    'oper_cost': '营业成本',
    'operate_profit': '营业利润',
    'total_profit': '利润总额',
    'n_income': '净利润',
    'basic_eps': '基本每股收益',

    // 资产负债表
    'total_assets': '资产总计',
    'total_liab': '负债合计',
    'total_hldr_eqy_exc_min_int': '归属股东权益合计',
    'total_cur_assets': '流动资产合计',
    'total_cur_liab': '流动负债合计',
    'cash_reser_cb': '货币资金'
};

const FIELD_TYPES = {
    'ts_code': 'string',
    'trade_date': 'int64',
    'open': 'float64',
    'high': 'float64',
    'low': 'float64',
    'close': 'float64',
    'pre_close': 'float64',
    'change': 'float64',
    'pct_chg': 'float64',
    'vol': 'float64',
    'amount': 'float64',
    'turnover_rate': 'float64',
    'turnover_rate_f': 'float64',
    'volume_ratio': 'float64',
    'pe': 'float64',
    'pe_ttm': 'float64',
    'pb': 'float64',
    'ps': 'float64',
    'ps_ttm': 'float64',
    'dv_ratio': 'float64',
    'dv_ttm': 'float64',
    'total_share': 'float64',
    'float_share': 'float64',
    'free_share': 'float64',
    'total_mv': 'float64',
    'circ_mv': 'float64',
    'n_cashflow_act': 'float64',
    'n_cashflow_inv_act': 'float64',
    'n_cash_flows_fnc_act': 'float64',
    'c_fr_sale_sg': 'float64',
    'c_paid_goods_s': 'float64',
    'net_profit': 'float64',
    'total_revenue': 'float64',
    'revenue': 'float64',
    'oper_cost': 'float64',
    'operate_profit': 'float64',
    'total_profit': 'float64',
    'n_income': 'float64',
    'basic_eps': 'float64',
    'total_assets': 'float64',
    'total_liab': 'float64',
    'total_hldr_eqy_exc_min_int': 'float64',
    'total_cur_assets': 'float64',
    'total_cur_liab': 'float64',
    'cash_reser_cb': 'float64'
};

// 页面加载时获取数据状态
document.addEventListener('DOMContentLoaded', function() {
    refreshDataStatus();
    updateModalTime();
});

function updateModalTime() {
    const now = new Date();
    const timeStr = now.toLocaleString('zh-CN');
    document.getElementById('currentTime').textContent = timeStr;

    const hour = now.getHours();
    const isAfterMarket = hour >= 18;
    document.getElementById('marketStatus').innerHTML = isAfterMarket
        ? '<span style="color: var(--accent-success);">已收盘，可更新今日数据</span>'
        : '<span style="color: var(--accent-warning);">未收盘，仅更新至上一交易日</span>';
    document.getElementById('includeToday').checked = isAfterMarket;
}

function refreshDataStatus() {
    fetch('/api/data/status')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                renderDataTables(data.data);
            }
        })
        .catch(error => {
            console.error('获取数据状态失败:', error);
            addLog('error', '获取数据状态失败: ' + error.message);
        });
}

function renderDataTables(data) {
    const tables = data.tables;
    let updatedCount = 0;

    // 统计数据
    tables.forEach(table => {
        if (table.latest_date) updatedCount++;
    });

    document.getElementById('tableCount').textContent = tables.length;
    document.getElementById('updatedCount').textContent = updatedCount;
    document.getElementById('tradingStatus').innerHTML = data.is_trading_day
        ? '<span style="color: var(--accent-success);">交易日</span>'
        : '<span style="color: var(--text-muted);">非交易日</span>';
    document.getElementById('lastUpdate').textContent = data.current_time.split(' ')[0];

    // 渲染表格
    const tbody = document.getElementById('dataTableBody');
    tbody.innerHTML = tables.map(table => `
        <tr>
            <td>
                <span class="badge ${table.status === 'updated' ? 'badge-success' : 'badge-warning'}">
                    ${table.status === 'updated' ? '已更新' : '待更新'}
                </span>
            </td>
            <td>
                <a href="#" onclick="showFields('${table.id}', '${table.name}', '${table.fields.join(',')}'); return false;"
                   style="color: var(--accent-primary); text-decoration: none;">
                    ${table.name}
                </a>
            </td>
            <td style="color: var(--text-secondary);">${table.description}</td>
            <td style="font-family: 'JetBrains Mono', monospace;">
                ${table.latest_date ? formatDate(table.latest_date) : '-'}
            </td>
            <td style="text-align: center;">
                <span class="badge badge-primary">${table.fields.length}</span>
            </td>
            <td>
                <button class="btn btn-sm" onclick="updateTable('${table.id}')">
                    更新
                </button>
            </td>
        </tr>
    `).join('');
}

function showFields(tableId, tableName, fieldsStr) {
    const fields = fieldsStr.split(',');
    const tbody = document.getElementById('fieldsTableBody');

    tbody.innerHTML = fields.map((field, index) => `
        <tr>
            <td style="text-align: center; color: var(--text-muted);">${index + 1}</td>
            <td style="font-family: 'JetBrains Mono', monospace; color: var(--accent-primary);">${field}</td>
            <td><span class="badge badge-primary">${FIELD_TYPES[field] || 'unknown'}</span></td>
            <td style="color: var(--text-secondary);">${FIELD_DESCRIPTIONS[field] || '-'}</td>
        </tr>
    `).join('');

    document.getElementById('fieldsTableName').textContent = `${tableName} - 字段详情`;
    document.getElementById('fieldsSection').style.display = 'block';
    document.getElementById('fieldsSection').scrollIntoView({ behavior: 'smooth' });
}

function closeFieldsSection() {
    document.getElementById('fieldsSection').style.display = 'none';
}

function formatDate(dateStr) {
    if (!dateStr) return '-';
    return `${dateStr.slice(0, 4)}-${dateStr.slice(4, 6)}-${dateStr.slice(6, 8)}`;
}

function showUpdateModal() {
    document.getElementById('updateModal').style.display = 'flex';
    updateModalTime();
}

function closeUpdateModal() {
    document.getElementById('updateModal').style.display = 'none';
}

function updateTable(tableId) {
    addLog('info', `开始更新 ${tableId}...`);

    const formData = new URLSearchParams();
    formData.append('type', tableId.replace('_daily', ''));
    formData.append('include_today', document.getElementById('includeToday').checked);

    fetch('/api/data/update/sync', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            type: tableId.replace('_daily', '').replace('daily', 'all'),
            include_today: document.getElementById('includeToday').checked
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            addLog('success', data.message);
            refreshDataStatus();
        } else {
            addLog('error', data.message);
        }
    })
    .catch(error => {
        addLog('error', '更新失败: ' + error.message);
    });
}

function executeUpdate() {
    const updateDaily = document.getElementById('updateDaily').checked;
    const updateDailyBasic = document.getElementById('updateDailyBasic').checked;
    const updateFinancial = document.getElementById('updateFinancial').checked;
    const includeToday = document.getElementById('includeToday').checked;

    let updateType = 'all';
    if (updateDaily && !updateDailyBasic && !updateFinancial) {
        updateType = 'daily';
    } else if (!updateDaily && updateDailyBasic && !updateFinancial) {
        updateType = 'daily_basic';
    } else if (!updateDaily && !updateDailyBasic && updateFinancial) {
        updateType = 'financial';
    }

    addLog('info', `开始更新数据...`);
    addLog('info', `更新类型: ${updateType}`);
    addLog('info', `包含今日: ${includeToday ? '是' : '否'}`);

    closeUpdateModal();

    fetch('/api/data/update/sync', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            type: updateType,
            include_today: includeToday
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            addLog('success', data.message);
            refreshDataStatus();
        } else {
            addLog('error', data.message);
        }
    })
    .catch(error => {
        addLog('error', '更新失败: ' + error.message);
    });
}

function addLog(type, message) {
    const logOutput = document.getElementById('logOutput');
    const time = new Date().toLocaleTimeString('zh-CN');

    let color = 'var(--text-secondary)';
    if (type === 'success') color = 'var(--accent-success)';
    if (type === 'error') color = 'var(--accent-danger)';
    if (type === 'info') color = 'var(--accent-info)';

    const logEntry = document.createElement('div');
    logEntry.innerHTML = `<span style="color: var(--text-muted);">[${time}]</span> <span style="color: ${color};">${message}</span>`;
    logOutput.insertBefore(logEntry, logOutput.firstChild);
}

function clearLogs() {
    document.getElementById('logOutput').innerHTML = '<div style="color: var(--text-muted);">日志已清空</div>';
}

// 点击模态框外部关闭
document.getElementById('updateModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeUpdateModal();
    }
});
</script>

<style>
.btn-primary {
    background: linear-gradient(135deg, var(--accent-primary), rgba(59, 130, 246, 0.8));
    border-color: var(--accent-primary);
    color: white;
}

.btn-primary:hover {
    border-color: var(--accent-primary);
    color: white;
    box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
}

.btn svg {
    width: 14px;
    height: 14px;
}

input[type="checkbox"] {
    accent-color: var(--accent-primary);
}
</style>
{% endblock %}
